{% extends 'base.html' %}
{% load static %}

{% block title %}Driver Dashboard - Rideon{% endblock %}

{% block extra_css %}
<style>
.rating-stars {
    cursor: pointer;
    font-size: 1.2em;
}

.rating-stars i {
    margin-right: 2px;
    transition: color 0.2s ease;
    cursor: pointer;
}

.rating-stars i:hover {
    color: #ffc107 !important;
}

.rating-display {
    font-size: 1em;
}

.rating-display i {
    margin-right: 1px;
}

.ride-card {
    transition: box-shadow 0.2s ease;
}

.ride-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Driver Status Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">
                                <i class="fas fa-car text-success me-2"></i>
                                Driver Dashboard
                            </h2>
                            <p class="text-muted mb-0">Manage your rides and view earnings</p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="d-flex align-items-center justify-content-md-end gap-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="availability-toggle">
                                    <label class="form-check-label" for="availability-toggle">
                                        <span id="availability-text">Offline</span>
                                    </label>
                                </div>
                                <button class="btn btn-outline-primary" onclick="refreshDriverDashboard()">
                                    <i class="fas fa-sync-alt me-2"></i>Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Phone Verification Alert -->
    <div class="row mb-4" id="phone-verification-alert" style="display: none;">
        <div class="col-12">
            <div class="alert alert-warning alert-dismissible fade show border-start border-warning border-4" role="alert">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="alert-heading mb-2">
                            <i class="fas fa-mobile-alt me-2"></i>Phone Verification Required for Drivers
                        </h6>
                        <p class="mb-0">
                            Drivers must verify their phone number to accept rides and communicate with riders securely.
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end mt-2 mt-md-0">
                        <a href="/verify-phone/" class="btn btn-warning btn-sm me-2">
                            <i class="fas fa-check-circle me-1"></i>Verify Now
                        </a>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-route display-6 mb-3"></i>
                    <h3 class="display-6 mb-1" id="total-trips">0</h3>
                    <p class="mb-0">Total Trips</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign display-6 mb-3"></i>
                    <h3 class="display-6 mb-1" id="total-earnings">â‚¦0</h3>
                    <p class="mb-0">Total Earnings</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-star display-6 mb-3"></i>
                    <h3 class="display-6 mb-1" id="average-rating">5.0</h3>
                    <p class="mb-0">Average Rating</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-clock display-6 mb-3"></i>
                    <h3 class="display-6 mb-1" id="active-hours">0h</h3>
                    <p class="mb-0">Today's Hours</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs mb-4" id="driver-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="available-rides-tab" data-bs-toggle="tab" 
                            data-bs-target="#available-rides" type="button" role="tab">
                        <i class="fas fa-search me-2"></i>Available Rides
                        <span class="badge bg-warning ms-2" id="available-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="my-rides-tab" data-bs-toggle="tab" 
                            data-bs-target="#my-rides" type="button" role="tab">
                        <i class="fas fa-car me-2"></i>My Rides
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="earnings-tab" data-bs-toggle="tab" 
                            data-bs-target="#earnings" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Earnings
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="driver-tab-content">
                <!-- Available Rides Tab -->
                <div class="tab-pane fade show active" id="available-rides" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-search me-2"></i>Available Rides
                            </h5>
                            <button class="btn btn-sm btn-primary" onclick="loadAvailableRides()">
                                <i class="fas fa-sync-alt me-2"></i>Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="available-rides-loading" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading available rides...</p>
                            </div>
                            
                            <div id="available-rides-container" class="d-none">
                                <!-- Available rides will be loaded here -->
                            </div>
                            
                            <div id="no-available-rides" class="text-center py-5 d-none">
                                <i class="fas fa-search text-muted display-4 mb-3"></i>
                                <h5 class="text-muted">No rides available</h5>
                                <p class="text-muted">Check back later for new ride requests.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Rides Tab -->
                <div class="tab-pane fade" id="my-rides" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-car me-2"></i>My Rides
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="my-rides-container">
                                <!-- Driver's rides will be loaded here -->
                            </div>
                            
                            <!-- Pagination for driver rides -->
                            <div id="driver-rides-pagination" class="d-none">
                                <nav aria-label="Driver rides pagination">
                                    <ul class="pagination justify-content-center mb-0">
                                        <!-- Pagination buttons will be generated here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Earnings Tab -->
                <div class="tab-pane fade" id="earnings" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>Earnings Overview
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">Today's Earnings</h6>
                                            <h3 class="text-success" id="today-earnings">â‚¦0.00</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <h6 class="text-muted">This Week</h6>
                                            <h3 class="text-primary" id="week-earnings">â‚¦0.00</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="mb-3">Recent Earnings</h6>
                            <div id="earnings-list">
                                <p class="text-muted text-center">No earnings data available yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accept Ride Modal -->
<div class="modal fade" id="accept-ride-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Accept Ride Request
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ride-details">
                <!-- Ride details will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-accept-btn">
                    <i class="fas fa-check me-2"></i>Accept Ride
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentRideId = null;
let driverRides = [];
        // Pagination variables for driver rides
        let currentDriverPage = 1;
        const driverRidesPerPage = 5;
        let filteredDriverRides = [];

        document.addEventListener('DOMContentLoaded', function() {
    // Redirect if not authenticated or not a driver
    if (!isAuthenticated()) {
        showAlert('Please login to access driver dashboard', 'warning');
        setTimeout(() => {
            window.location.href = '/login/';
        }, 2000);
        return;
    }

    // Check if user is a driver
    const userType = localStorage.getItem('user_type');
    if (userType !== 'DRIVER') {
        showAlert('Access denied. Driver account required.', 'danger');
        setTimeout(() => {
            window.location.href = '/dashboard/';
        }, 2000);
        return;
    }

    loadDriverDashboard();
    
    // Set up availability toggle
    document.getElementById('availability-toggle').addEventListener('change', toggleAvailability);
    
    // Load available rides initially
    loadAvailableRides();
    
    // Auto-refresh available rides every 30 seconds
    setInterval(loadAvailableRides, 30000);
});

async function loadDriverDashboard() {
    try {
        // Load driver profile and statistics
        await Promise.all([
            loadDriverProfile(),
            loadDriverRides(),
            loadDriverEarnings()
        ]);
        
        // Check phone verification status
        await checkDriverPhoneVerification();
    } catch (error) {
        console.error('Error loading driver dashboard:', error);
        showAlert('Error loading dashboard data', 'danger');
    }
}

async function loadDriverProfile() {
    try {
        const response = await makeAuthenticatedRequest('/driver-profile/');
        if (response.ok) {
            const profile = await response.json();
            document.getElementById('availability-toggle').checked = profile.is_available;
            updateAvailabilityText(profile.is_available);
            document.getElementById('average-rating').textContent = profile.rating;
        }
    } catch (error) {
        console.error('Error loading driver profile:', error);
    }
}

async function loadDriverRides() {
    try {
        const response = await makeAuthenticatedRequest('/api/');
        if (response.ok) {
            const rides = await response.json();
            driverRides = rides.filter(ride => ride.driver && ride.driver.id === parseInt(localStorage.getItem('user_id')));
            filteredDriverRides = driverRides; // Initialize filtered rides
            currentDriverPage = 1; // Reset to first page
            
            updateDriverStatistics(driverRides);
            displayDriverRides(filteredDriverRides);
        }
    } catch (error) {
        console.error('Error loading driver rides:', error);
    }
}

async function loadAvailableRides() {
    try {
        const response = await makeAuthenticatedRequest('/api/available/');
        
        if (response.ok) {
            const rides = await response.json();
            displayAvailableRides(rides);
            document.getElementById('available-count').textContent = rides.length;
        } else {
            throw new Error('Failed to load available rides');
        }
    } catch (error) {
        console.error('Error loading available rides:', error);
        document.getElementById('available-rides-loading').classList.add('d-none');
        document.getElementById('no-available-rides').classList.remove('d-none');
    }
}

function displayAvailableRides(rides) {
    const container = document.getElementById('available-rides-container');
    const loading = document.getElementById('available-rides-loading');
    const noRides = document.getElementById('no-available-rides');
    
    loading.classList.add('d-none');
    
    if (rides.length === 0) {
        container.classList.add('d-none');
        noRides.classList.remove('d-none');
        return;
    }
    
    container.classList.remove('d-none');
    noRides.classList.add('d-none');
    
    const ridesHTML = rides.map(ride => `
        <div class="card ride-card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-5">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <i class="fas fa-map-marker-alt text-success fs-5"></i>
                                <div class="border-start border-2 ms-2" style="height: 20px;"></div>
                                <i class="fas fa-flag text-danger fs-5"></i>
                            </div>
                            <div>
                                <p class="mb-1 fw-semibold">${ride.pickup_location}</p>
                                <p class="mb-0 text-muted">${ride.dropoff_location}</p>
                            </div>
                        </div>
                        ${ride.notes ? `<small class="text-muted"><i class="fas fa-comment me-1"></i>${ride.notes}</small>` : ''}
                    </div>
                    <div class="col-md-2 text-center">
                        <small class="text-muted">Requested</small>
                        <p class="mb-0 fw-semibold">${formatDate(ride.created_at)}</p>
                    </div>
                    <div class="col-md-2 text-center">
                        <small class="text-muted">Estimated Fare</small>
                        <p class="mb-0 fw-semibold text-success">â‚¦${calculateEstimatedFare(ride).toFixed(2)}</p>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-success" onclick="showAcceptRideModal(${ride.id})">
                            <i class="fas fa-check me-2"></i>Accept Ride
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = ridesHTML;
}

function displayDriverRides(rides) {
    const container = document.getElementById('my-rides-container');
    const paginationContainer = document.getElementById('driver-rides-pagination');
    
    if (rides.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-car text-muted display-4 mb-3"></i>
                <h5 class="text-muted">No rides completed yet</h5>
                <p class="text-muted">Accept ride requests to start earning!</p>
            </div>
        `;
        paginationContainer.classList.add('d-none');
        return;
    }
    
    // Calculate pagination
    const totalPages = Math.ceil(rides.length / driverRidesPerPage);
    const startIndex = (currentDriverPage - 1) * driverRidesPerPage;
    const endIndex = startIndex + driverRidesPerPage;
    const currentRides = rides.slice(startIndex, endIndex);
    
    const ridesHTML = currentRides.map(ride => `
        <div class="card ride-card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <i class="fas fa-map-marker-alt text-success fs-5"></i>
                                <div class="border-start border-2 ms-2" style="height: 20px;"></div>
                                <i class="fas fa-flag text-danger fs-5"></i>
                            </div>
                            <div>
                                <p class="mb-1 fw-semibold">${ride.pickup_location}</p>
                                <p class="mb-0 text-muted">${ride.dropoff_location}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 text-center">
                        ${formatRideStatus(ride.status)}
                    </div>
                    <div class="col-md-2 text-center">
                        <small class="text-muted">Fare</small>
                        <p class="mb-0 fw-semibold">${formatFare(ride.fare)}</p>
                    </div>
                    <div class="col-md-2 text-end">
                        ${ride.status === 'accepted' ? `
                            <div class="btn-group-vertical gap-1">
                                <button class="btn btn-primary btn-sm" onclick="updateRideStatus(${ride.id}, 'in_progress')">
                                    <i class="fas fa-play me-1"></i>Start Trip
                                </button>
                                <button class="btn btn-outline-info btn-sm" onclick="sendArrivalNotification(${ride.id})">
                                    <i class="fas fa-bell me-1"></i>I'm Here
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="showRideMessages(${ride.id})">
                                    <i class="fas fa-comment me-1"></i>Contact
                                </button>
                            </div>
                        ` : ride.status === 'in_progress' ? `
                            <div class="btn-group-vertical gap-1">
                                <button class="btn btn-success btn-sm" onclick="updateRideStatus(${ride.id}, 'completed')">
                                    <i class="fas fa-check me-1"></i>Complete
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="showRideMessages(${ride.id})">
                                    <i class="fas fa-comment me-1"></i>Contact
                                </button>
                            </div>
                        ` : ride.status === 'completed' ? `
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showRideMessages(${ride.id})">
                                        <i class="fas fa-comment me-2"></i>Messages
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showRideRatings(${ride.id})">
                                        <i class="fas fa-star me-2"></i>View Ratings
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showRatingModal(${ride.id})">
                                        <i class="fas fa-star me-2"></i>Rate Rider
                                    </a></li>
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = ridesHTML;
    
    // Update pagination for driver rides
    updateDriverPagination(totalPages, rides.length);
}

function updateDriverPagination(totalPages, totalItems) {
    const paginationContainer = document.getElementById('driver-rides-pagination');
    
    if (totalPages <= 1) {
        paginationContainer.classList.add('d-none');
        return;
    }
    
    paginationContainer.classList.remove('d-none');
    
    let paginationHTML = '<nav><ul class="pagination justify-content-center mb-0">';
    
    // Previous button
    paginationHTML += `
        <li class="page-item ${currentDriverPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeDriverPage(${currentDriverPage - 1})" ${currentDriverPage === 1 ? 'tabindex="-1"' : ''}>
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `;
    
    // Page numbers
    const startPage = Math.max(1, currentDriverPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);
    
    if (startPage > 1) {
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeDriverPage(1)">1</a></li>`;
        if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <li class="page-item ${i === currentDriverPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changeDriverPage(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changeDriverPage(${totalPages})">${totalPages}</a></li>`;
    }
    
    // Next button
    paginationHTML += `
        <li class="page-item ${currentDriverPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changeDriverPage(${currentDriverPage + 1})" ${currentDriverPage === totalPages ? 'tabindex="-1"' : ''}>
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `;
    
    paginationHTML += '</ul></nav>';
    
    // Add pagination info
    const startItem = (currentDriverPage - 1) * driverRidesPerPage + 1;
    const endItem = Math.min(currentDriverPage * driverRidesPerPage, totalItems);
    
    paginationHTML += `
        <div class="text-center mt-2">
            <small class="text-muted">
                Showing ${startItem}-${endItem} of ${totalItems} rides
            </small>
        </div>
    `;
    
    paginationContainer.innerHTML = paginationHTML;
}

function changeDriverPage(newPage) {
    if (newPage >= 1 && newPage <= Math.ceil(filteredDriverRides.length / driverRidesPerPage)) {
        currentDriverPage = newPage;
        displayDriverRides(filteredDriverRides);
    }
}

function updateDriverStatistics(rides) {
    const completedRides = rides.filter(r => r.status === 'completed');
    const totalEarnings = completedRides.reduce((sum, r) => sum + (parseFloat(r.fare) || 0), 0);
    
    document.getElementById('total-trips').textContent = completedRides.length;
    document.getElementById('total-earnings').textContent = `â‚¦${totalEarnings.toFixed(2)}`;
    
    // Load driver ratings
    loadDriverRatings();
}

async function loadDriverRatings() {
    try {
        const response = await makeAuthenticatedRequest('/api/my-ratings/');
        
        if (response.ok) {
            const ratingsData = await response.json();
            const averageRating = ratingsData.averages.overall || 0;
            document.getElementById('average-rating').textContent = averageRating.toFixed(1);
        }
    } catch (error) {
        console.error('Error loading driver ratings:', error);
        document.getElementById('average-rating').textContent = '5.0';
    }
}

async function loadDriverEarnings() {
    // This would typically load from a dedicated earnings endpoint
    // For now, we'll use the rides data
    const today = new Date().toDateString();
    // Mock data for demonstration
    document.getElementById('today-earnings').textContent = 'â‚¦0.00';
    document.getElementById('week-earnings').textContent = 'â‚¦0.00';
}

async function toggleAvailability() {
    const isAvailable = document.getElementById('availability-toggle').checked;
    
    try {
        const response = await makeAuthenticatedRequest('/driver-profile/', {
            method: 'PUT',
            body: JSON.stringify({ is_available: isAvailable })
        });
        
        if (response.ok) {
            updateAvailabilityText(isAvailable);
            showAlert(`You are now ${isAvailable ? 'online' : 'offline'}`, 'success', 3000);
        } else {
            throw new Error('Failed to update availability');
        }
    } catch (error) {
        console.error('Error updating availability:', error);
        showAlert('Error updating availability', 'danger');
        // Revert toggle
        document.getElementById('availability-toggle').checked = !isAvailable;
    }
}

function updateAvailabilityText(isAvailable) {
    const text = document.getElementById('availability-text');
    text.textContent = isAvailable ? 'Online' : 'Offline';
    text.className = isAvailable ? 'text-success' : 'text-muted';
}

async function showAcceptRideModal(rideId) {
    currentRideId = rideId;
    
    try {
        // Get ride details (for now we'll use the data we already have)
        const response = await makeAuthenticatedRequest('/api/available/');
        const rides = await response.json();
        const ride = rides.find(r => r.id === rideId);
        
        if (ride) {
            const modalBody = document.getElementById('ride-details');
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-map-marker-alt text-success me-2"></i>Pickup</h6>
                        <p>${ride.pickup_location}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-flag text-danger me-2"></i>Dropoff</h6>
                        <p>${ride.dropoff_location}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-dollar-sign text-success me-2"></i>Estimated Fare</h6>
                        <p class="text-success fw-bold fs-5">â‚¦${calculateEstimatedFare(ride).toFixed(2)}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-credit-card me-2"></i>Payment Method</h6>
                        <p>${ride.payment_method || 'Cash'}</p>
                    </div>
                </div>
                ${ride.notes ? `
                    <div class="mt-3">
                        <h6><i class="fas fa-comment me-2"></i>Notes</h6>
                        <p class="text-muted">${ride.notes}</p>
                    </div>
                ` : ''}
                <div class="mt-3">
                    <h6><i class="fas fa-user me-2"></i>Rider</h6>
                    <p>${ride.rider.email}</p>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('accept-ride-modal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading ride details:', error);
        showAlert('Error loading ride details', 'danger');
    }
}

document.getElementById('confirm-accept-btn').addEventListener('click', async function() {
    if (!currentRideId) return;
    
    try {
        const response = await makeAuthenticatedRequest(`/api/${currentRideId}/accept/`, {
            method: 'PUT'
        });
        
        if (response.ok) {
            showAlert('Ride accepted successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('accept-ride-modal'));
            modal.hide();
            
            // Refresh data
            loadAvailableRides();
            loadDriverRides();
            
            currentRideId = null;
        } else {
            throw new Error('Failed to accept ride');
        }
    } catch (error) {
        console.error('Error accepting ride:', error);
        showAlert('Error accepting ride', 'danger');
    }
});

async function updateRideStatus(rideId, status) {
    try {
        const response = await makeAuthenticatedRequest(`/api/${rideId}/status/`, {
            method: 'PUT',
            body: JSON.stringify({ status: status })
        });
        
        if (response.ok) {
            const statusText = status === 'in_progress' ? 'started' : 'completed';
            showAlert(`Ride ${statusText} successfully!`, 'success');
            loadDriverRides();
        } else {
            throw new Error(`Failed to ${status} ride`);
        }
    } catch (error) {
        console.error('Error updating ride status:', error);
        showAlert('Error updating ride status', 'danger');
    }
}

function refreshDriverDashboard() {
    showAlert('Refreshing dashboard...', 'info', 2000);
    loadDriverDashboard();
    loadAvailableRides();
}

// Driver-Rider Communication Functions
async function sendArrivalNotification(rideId) {
    try {
        const response = await makeAuthenticatedRequest(`/api/${rideId}/arrival/`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showAlert('Arrival notification sent to rider!', 'success');
        } else {
            throw new Error('Failed to send arrival notification');
        }
    } catch (error) {
        console.error('Error sending arrival notification:', error);
        showAlert('Error sending notification', 'danger');
    }
}

function showRideMessages(rideId) {
    // Create and show messages modal
    const modalHtml = `
        <div class="modal fade" id="messages-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-comment me-2"></i>Ride Messages
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="messages-container" style="max-height: 300px; overflow-y: auto;" class="mb-3">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading messages...</span>
                                </div>
                            </div>
                        </div>
                        <form id="send-message-form">
                            <div class="input-group">
                                <select class="form-select" id="message-type" style="max-width: 150px;">
                                    <option value="general">General</option>
                                    <option value="pickup_delay">Pickup Delay</option>
                                    <option value="route_change">Route Change</option>
                                </select>
                                <input type="text" class="form-control" id="message-input" placeholder="Type your message..." required>
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('messages-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('messages-modal'));
    modal.show();
    
    // Load messages
    loadRideMessages(rideId);
    
    // Set up message sending
    document.getElementById('send-message-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await sendRideMessage(rideId);
    });
}

async function loadRideMessages(rideId) {
    try {
        const response = await makeAuthenticatedRequest(`/api/${rideId}/messages/`);
        
        if (response.ok) {
            const messages = await response.json();
            displayMessages(messages);
        } else {
            throw new Error('Failed to load messages');
        }
    } catch (error) {
        console.error('Error loading messages:', error);
        document.getElementById('messages-container').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Unable to load messages
            </div>
        `;
    }
}

function displayMessages(messages) {
    const container = document.getElementById('messages-container');
    
    if (messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-3 text-muted">
                <i class="fas fa-comment-slash mb-2"></i>
                <p>No messages yet</p>
            </div>
        `;
        return;
    }
    
    const messagesHtml = messages.map(message => {
        const isDriver = message.sender.user_type === 'driver';
        const messageClass = isDriver ? 'bg-primary text-white ms-auto' : 'bg-light';
        const alignment = isDriver ? 'justify-content-end' : 'justify-content-start';
        
        return `
            <div class="d-flex ${alignment} mb-2">
                <div class="card ${messageClass}" style="max-width: 70%;">
                    <div class="card-body p-2">
                        <div class="d-flex align-items-center mb-1">
                            <small class="fw-semibold">${isDriver ? 'Driver' : 'Rider'}</small>
                            ${message.message_type !== 'general' ? `
                                <span class="badge badge-sm bg-info ms-2">${message.message_type.replace('_', ' ')}</span>
                            ` : ''}
                        </div>
                        <p class="mb-1">${message.message}</p>
                        <small class="opacity-75">${formatDate(message.created_at)}</small>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = messagesHtml;
    container.scrollTop = container.scrollHeight;
}

async function sendRideMessage(rideId) {
    const messageInput = document.getElementById('message-input');
    const messageType = document.getElementById('message-type');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    try {
        const response = await makeAuthenticatedRequest(`/api/${rideId}/messages/`, {
            method: 'POST',
            body: JSON.stringify({
                message: message,
                message_type: messageType.value
            })
        });
        
        if (response.ok) {
            messageInput.value = '';
            messageType.value = 'general';
            loadRideMessages(rideId); // Refresh messages
        } else {
            throw new Error('Failed to send message');
        }
    } catch (error) {
        console.error('Error sending message:', error);
        showAlert('Error sending message', 'danger');
    }
}

// Rating Functions for Driver Dashboard
function showRatingModal(rideId) {
    const modalHtml = `
        <div class="modal fade" id="rating-modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-star me-2"></i>Rate Rider
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="rating-form">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Overall Rating *</label>
                                <div class="rating-stars" data-rating="0">
                                    <i class="fas fa-star" data-value="1"></i>
                                    <i class="fas fa-star" data-value="2"></i>
                                    <i class="fas fa-star" data-value="3"></i>
                                    <i class="fas fa-star" data-value="4"></i>
                                    <i class="fas fa-star" data-value="5"></i>
                                </div>
                                <input type="hidden" id="overall-rating" name="rating" required>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Punctuality</label>
                                <div class="rating-stars" data-rating="0" data-field="punctuality">
                                    <i class="fas fa-star" data-value="1"></i>
                                    <i class="fas fa-star" data-value="2"></i>
                                    <i class="fas fa-star" data-value="3"></i>
                                    <i class="fas fa-star" data-value="4"></i>
                                    <i class="fas fa-star" data-value="5"></i>
                                </div>
                                <input type="hidden" id="punctuality-rating" name="punctuality">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Communication</label>
                                <div class="rating-stars" data-rating="0" data-field="communication">
                                    <i class="fas fa-star" data-value="1"></i>
                                    <i class="fas fa-star" data-value="2"></i>
                                    <i class="fas fa-star" data-value="3"></i>
                                    <i class="fas fa-star" data-value="4"></i>
                                    <i class="fas fa-star" data-value="5"></i>
                                </div>
                                <input type="hidden" id="communication-rating" name="communication">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Professionalism</label>
                                <div class="rating-stars" data-rating="0" data-field="professionalism">
                                    <i class="fas fa-star" data-value="1"></i>
                                    <i class="fas fa-star" data-value="2"></i>
                                    <i class="fas fa-star" data-value="3"></i>
                                    <i class="fas fa-star" data-value="4"></i>
                                    <i class="fas fa-star" data-value="5"></i>
                                </div>
                                <input type="hidden" id="professionalism-rating" name="professionalism">
                            </div>
                            
                            <div class="mb-3">
                                <label for="rating-comment" class="form-label">Comment (Optional)</label>
                                <textarea class="form-control" id="rating-comment" name="comment" rows="3" placeholder="Share your experience with this rider..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-star me-2"></i>Submit Rating
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('rating-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Set up star rating interactions
    setupStarRatings();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('rating-modal'));
    modal.show();
    
    // Handle form submission
    document.getElementById('rating-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        await submitRating(rideId);
    });
}

function setupStarRatings() {
    const ratingContainers = document.querySelectorAll('.rating-stars');
    
    ratingContainers.forEach(container => {
        const stars = container.querySelectorAll('i');
        const field = container.dataset.field || 'rating';
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                const rating = index + 1;
                container.dataset.rating = rating;
                
                // Update hidden input
                const inputId = field === 'rating' ? 'overall-rating' : `${field}-rating`;
                document.getElementById(inputId).value = rating;
                
                // Update star display
                updateStarDisplay(container, rating);
            });
            
            star.addEventListener('mouseenter', () => {
                const rating = index + 1;
                updateStarDisplay(container, rating);
            });
        });
        
        container.addEventListener('mouseleave', () => {
            const currentRating = parseInt(container.dataset.rating) || 0;
            updateStarDisplay(container, currentRating);
        });
    });
}

function updateStarDisplay(container, rating) {
    const stars = container.querySelectorAll('i');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.remove('far');
            star.classList.add('fas', 'text-warning');
        } else {
            star.classList.remove('fas', 'text-warning');
            star.classList.add('far');
        }
    });
}

async function submitRating(rideId) {
    try {
        const formData = new FormData(document.getElementById('rating-form'));
        const ratingData = {
            rating: parseInt(formData.get('rating')),
            comment: formData.get('comment') || '',
            punctuality: formData.get('punctuality') ? parseInt(formData.get('punctuality')) : null,
            communication: formData.get('communication') ? parseInt(formData.get('communication')) : null,
            professionalism: formData.get('professionalism') ? parseInt(formData.get('professionalism')) : null
        };
        
        const response = await makeAuthenticatedRequest(`/api/${rideId}/ratings/`, {
            method: 'POST',
            body: JSON.stringify(ratingData)
        });
        
        if (response.ok) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('rating-modal'));
            modal.hide();
            showAlert('Rating submitted successfully!', 'success');
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || 'Failed to submit rating');
        }
    } catch (error) {
        console.error('Error submitting rating:', error);
        showAlert(error.message, 'danger');
    }
}

function showRideRatings(rideId) {
    loadRideRatings(rideId);
}

async function loadRideRatings(rideId) {
    try {
        const response = await makeAuthenticatedRequest(`/api/${rideId}/ratings/`);
        
        if (response.ok) {
            const ratings = await response.json();
            displayRatingsModal(ratings, rideId);
        } else {
            throw new Error('Failed to load ratings');
        }
    } catch (error) {
        console.error('Error loading ratings:', error);
        showAlert('Error loading ratings', 'danger');
    }
}

function displayRatingsModal(ratings, rideId) {
    const modalHtml = `
        <div class="modal fade" id="ratings-view-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-star me-2"></i>Ride Ratings
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${ratings.length === 0 ? `
                            <div class="text-center py-4">
                                <i class="fas fa-star text-muted display-4 mb-3"></i>
                                <p class="text-muted">No ratings yet for this ride</p>
                            </div>
                        ` : ratings.map(rating => `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="me-3">
                                            <strong>${rating.rater.email.split('@')[0]}</strong>
                                            <small class="text-muted d-block">rated ${rating.rated_user.email.split('@')[0]}</small>
                                        </div>
                                        <div class="ms-auto">
                                            <div class="rating-display">
                                                ${generateStarDisplay(rating.rating)}
                                            </div>
                                            <small class="text-muted">${formatDate(rating.created_at)}</small>
                                        </div>
                                    </div>
                                    
                                    ${rating.comment ? `
                                        <p class="mb-3">"${rating.comment}"</p>
                                    ` : ''}
                                    
                                    <div class="row">
                                        ${rating.punctuality ? `
                                            <div class="col-md-3 mb-2">
                                                <small class="text-muted d-block">Punctuality</small>
                                                ${generateStarDisplay(rating.punctuality)}
                                            </div>
                                        ` : ''}
                                        ${rating.communication ? `
                                            <div class="col-md-3 mb-2">
                                                <small class="text-muted d-block">Communication</small>
                                                ${generateStarDisplay(rating.communication)}
                                            </div>
                                        ` : ''}
                                        ${rating.professionalism ? `
                                            <div class="col-md-3 mb-2">
                                                <small class="text-muted d-block">Professionalism</small>
                                                ${generateStarDisplay(rating.professionalism)}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('ratings-view-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('ratings-view-modal'));
    modal.show();
}

function generateStarDisplay(rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        if (i <= rating) {
            stars += '<i class="fas fa-star text-warning"></i>';
        } else {
            stars += '<i class="far fa-star text-muted"></i>';
        }
    }
    return stars;
}

async function checkDriverPhoneVerification() {
    try {
        const response = await makeAuthenticatedRequest('/profile/');
        if (response.ok) {
            const userProfile = await response.json();
            const phoneVerificationAlert = document.getElementById('phone-verification-alert');
            
            if (!userProfile.is_phone_verified) {
                phoneVerificationAlert.style.display = 'block';
            } else {
                phoneVerificationAlert.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error checking phone verification status:', error);
    }
}
</script>
{% endblock %}
