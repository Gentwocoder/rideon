{% extends 'base.html' %}
{% load static %}

{% block title %}Request a Ride - Rideon{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Request a Ride
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form id="ride-request-form">
                        <!-- Pickup Location -->
                        <div class="mb-4">
                            <label for="pickup_location" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt text-success me-2"></i>Pickup Location *
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="pickup_location" name="pickup_location" 
                                       placeholder="Enter pickup address" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="getCurrentLocation('pickup')">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                            <input type="hidden" id="pickup_latitude" name="pickup_latitude">
                            <input type="hidden" id="pickup_longitude" name="pickup_longitude">
                        </div>

                        <!-- Dropoff Location -->
                        <div class="mb-4">
                            <label for="dropoff_location" class="form-label fw-bold">
                                <i class="fas fa-flag text-danger me-2"></i>Dropoff Location *
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="dropoff_location" name="dropoff_location" 
                                       placeholder="Enter destination address" required>
                                <button class="btn btn-outline-secondary" type="button" onclick="getCurrentLocation('dropoff')">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                            <input type="hidden" id="dropoff_latitude" name="dropoff_latitude">
                            <input type="hidden" id="dropoff_longitude" name="dropoff_longitude">
                        </div>

                        <!-- Map Preview -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-map me-2"></i>Route Preview
                            </label>
                            <div class="map-container bg-light border rounded d-flex align-items-center justify-content-center">
                                <div class="text-center text-muted">
                                    <i class="fas fa-map display-4 mb-3"></i>
                                    <p>Map will appear here when locations are set</p>
                                    <small>Interactive map integration coming soon</small>
                                </div>
                            </div>
                        </div>

                        <!-- Ride Details -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-route text-primary mb-2"></i>
                                        <h6>Distance</h6>
                                        <p class="mb-0" id="estimated-distance">--</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-clock text-warning mb-2"></i>
                                        <h6>Duration</h6>
                                        <p class="mb-0" id="estimated-duration">--</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-dollar-sign text-success mb-2"></i>
                                        <h6>Estimated Fare</h6>
                                        <p class="mb-0" id="estimated-fare">--</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-4">
                            <label for="notes" class="form-label fw-bold">
                                <i class="fas fa-comment me-2"></i>Additional Notes (Optional)
                            </label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Any special instructions for the driver..."></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="fas fa-paper-plane me-2"></i>
                                <span id="submit-text">Request Ride</span>
                                <div class="spinner-border spinner-border-sm d-none" id="submit-spinner"></div>
                            </button>
                            <a href="/dashboard/" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="success-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Ride Requested Successfully!
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-car text-success display-4 mb-3"></i>
                <h5>Your ride has been requested</h5>
                <p class="text-muted">We're looking for nearby drivers. You'll be notified when a driver accepts your ride.</p>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Ride ID:</strong> <span id="ride-id">--</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="goToDashboard()">
                    <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Redirect if not authenticated
    if (!isAuthenticated()) {
        showAlert('Please login to request a ride', 'warning');
        setTimeout(() => {
            window.location.href = '/login/';
        }, 2000);
        return;
    }

    // Set up form submission
    document.getElementById('ride-request-form').addEventListener('submit', handleRideRequest);
    
    // Set up location change listeners
    document.getElementById('pickup_location').addEventListener('blur', updateEstimates);
    document.getElementById('dropoff_location').addEventListener('blur', updateEstimates);
});

async function handleRideRequest(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    
    // Validate form
    if (!validateRideForm()) {
        return;
    }
    
    // Show loading state
    submitText.textContent = 'Requesting Ride...';
    submitSpinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(e.target);
        const rideData = {
            pickup_location: formData.get('pickup_location'),
            pickup_latitude: parseFloat(formData.get('pickup_latitude')) || 0,
            pickup_longitude: parseFloat(formData.get('pickup_longitude')) || 0,
            dropoff_location: formData.get('dropoff_location'),
            dropoff_latitude: parseFloat(formData.get('dropoff_latitude')) || 0,
            dropoff_longitude: parseFloat(formData.get('dropoff_longitude')) || 0,
            notes: formData.get('notes') || ''
        };
        
        const response = await makeAuthenticatedRequest('/api/', {
            method: 'POST',
            body: JSON.stringify(rideData)
        });
        
        if (response.ok) {
            const result = await response.json();
            document.getElementById('ride-id').textContent = result.id;
            
            // Show success modal
            const modal = new bootstrap.Modal(document.getElementById('success-modal'));
            modal.show();
            
            // Reset form
            e.target.reset();
            clearEstimates();
            
        } else {
            const error = await response.json();
            throw new Error(error.message || 'Failed to request ride');
        }
        
    } catch (error) {
        console.error('Error requesting ride:', error);
        showAlert(error.message || 'Error requesting ride. Please try again.', 'danger');
    } finally {
        // Reset button state
        submitText.textContent = 'Request Ride';
        submitSpinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
}

function validateRideForm() {
    const pickupLocation = document.getElementById('pickup_location').value.trim();
    const dropoffLocation = document.getElementById('dropoff_location').value.trim();
    
    if (!pickupLocation) {
        showAlert('Please enter a pickup location', 'warning');
        document.getElementById('pickup_location').focus();
        return false;
    }
    
    if (!dropoffLocation) {
        showAlert('Please enter a dropoff location', 'warning');
        document.getElementById('dropoff_location').focus();
        return false;
    }
    
    if (pickupLocation.toLowerCase() === dropoffLocation.toLowerCase()) {
        showAlert('Pickup and dropoff locations cannot be the same', 'warning');
        return false;
    }
    
    return true;
}

async function getCurrentLocation(type) {
    try {
        showAlert('Getting your current location...', 'info', 3000);
        
        const location = await getUserLocation();
        
        // For demo purposes, we'll set mock coordinates
        // In a real app, you'd use a geocoding service to get the address
        const mockAddress = `Current Location (${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)})`;
        
        if (type === 'pickup') {
            document.getElementById('pickup_location').value = mockAddress;
            document.getElementById('pickup_latitude').value = location.latitude;
            document.getElementById('pickup_longitude').value = location.longitude;
        } else {
            document.getElementById('dropoff_location').value = mockAddress;
            document.getElementById('dropoff_latitude').value = location.latitude;
            document.getElementById('dropoff_longitude').value = location.longitude;
        }
        
        updateEstimates();
        showAlert('Location updated successfully', 'success', 2000);
        
    } catch (error) {
        console.error('Error getting location:', error);
        showAlert('Unable to get your location. Please enter it manually.', 'warning');
    }
}

function updateEstimates() {
    const pickupLat = parseFloat(document.getElementById('pickup_latitude').value);
    const pickupLng = parseFloat(document.getElementById('pickup_longitude').value);
    const dropoffLat = parseFloat(document.getElementById('dropoff_latitude').value);
    const dropoffLng = parseFloat(document.getElementById('dropoff_longitude').value);
    
    if (pickupLat && pickupLng && dropoffLat && dropoffLng) {
        // Calculate estimates
        const distance = calculateDistance(pickupLat, pickupLng, dropoffLat, dropoffLng);
        const duration = Math.round(distance * 2.5); // Rough estimate: 2.5 minutes per km
        const baseFare = 3.00; // Base fare
        const perKmRate = 1.50; // Rate per km
        const fare = baseFare + (distance * perKmRate);
        
        document.getElementById('estimated-distance').textContent = `${distance} km`;
        document.getElementById('estimated-duration').textContent = `${duration} min`;
        document.getElementById('estimated-fare').textContent = formatCurrency(fare);
    } else {
        clearEstimates();
    }
}

function clearEstimates() {
    document.getElementById('estimated-distance').textContent = '--';
    document.getElementById('estimated-duration').textContent = '--';
    document.getElementById('estimated-fare').textContent = '--';
}

function goToDashboard() {
    window.location.href = '/dashboard/';
}

// Mock geocoding function (in a real app, you'd use Google Maps API or similar)
function geocodeAddress(address) {
    // This is a mock function
    // In reality, you'd call a geocoding service
    return new Promise((resolve) => {
        setTimeout(() => {
            // Return mock coordinates
            resolve({
                latitude: 40.7128 + (Math.random() - 0.5) * 0.1,
                longitude: -74.0060 + (Math.random() - 0.5) * 0.1
            });
        }, 1000);
    });
}
</script>
{% endblock %}
