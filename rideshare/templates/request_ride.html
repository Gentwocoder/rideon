{% extends 'base.html' %}
{% load static %}

{% block title %}Request a Ride - Rideon{% endblock %}

{% block extra_head %}
<!-- Google Maps API -->
<!-- Note: Replace 'YOUR_API_KEY' with your actual Google Maps API key -->
<!-- Get your API key from: https://developers.google.com/maps/documentation/javascript/get-api-key -->
<!-- For demo purposes, we'll use a fallback map system when Google Maps is not available -->
<script>
    // Check if we have a valid Google Maps API key
    const GOOGLE_MAPS_API_KEY = 'YOUR_API_KEY'; // Replace with your actual API key
    
    // Only load Google Maps if we have a valid API key
    if (GOOGLE_MAPS_API_KEY && GOOGLE_MAPS_API_KEY !== 'YOUR_API_KEY') {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,geometry&callback=initMap`;
        script.async = true;
        script.defer = true;
        script.onerror = function() {
            console.warn('Google Maps API failed to load, using fallback map');
            window.useGoogleMaps = false;
            waitForLeafletAndInit();
        };
        document.head.appendChild(script);
        window.useGoogleMaps = true;
    } else {
        console.warn('Google Maps API key not configured, using fallback map');
        window.useGoogleMaps = false;
        // Wait for both DOM and Leaflet to be ready
        waitForLeafletAndInit();
    }
    
    function waitForLeafletAndInit() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkLeafletAndInit);
        } else {
            checkLeafletAndInit();
        }
    }
    
    function checkLeafletAndInit() {
        // Add timeout to prevent infinite waiting
        if (!window.leafletInitAttempts) {
            window.leafletInitAttempts = 0;
        }
        window.leafletInitAttempts++;
        
        if (window.leafletInitAttempts > 50) { // 5 seconds max wait
            console.error('Timeout waiting for Leaflet libraries');
            // Try to initialize without routing if available
            if (typeof L !== 'undefined') {
                console.log('Initializing Leaflet without routing...');
                initFallbackMapSimple();
            } else {
                console.error('Leaflet completely unavailable, showing error');
                showMapError();
            }
            return;
        }
        
        if (typeof L !== 'undefined' && typeof L.Routing !== 'undefined') {
            console.log('Leaflet and routing library loaded, initializing map...');
            initFallbackMap();
        } else if (typeof L !== 'undefined') {
            console.log('Leaflet loaded but routing library still loading...');
            setTimeout(checkLeafletAndInit, 100);
        } else {
            console.log('Waiting for Leaflet to load...');
            setTimeout(checkLeafletAndInit, 100);
        }
    }
</script>
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- Leaflet Routing Machine CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" onload="console.log('Leaflet core loaded successfully')"></script>
<!-- Leaflet Routing Machine JS -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js" onload="console.log('Leaflet routing loaded successfully')"></script>
<style>
    #map {
        width: 100%;
        height: 100%;
    }
    .gm-style-iw {
        color: #333;
    }
    .suggestions-dropdown {
        border-color: #dee2e6 !important;
    }
    .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.2s ease;
    }
    .suggestion-item:last-child {
        border-bottom: none;
    }
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    .suggestion-item.active {
        background-color: #e3f2fd;
    }
    .suggestion-main {
        font-weight: 500;
        color: #212529;
    }
    .suggestion-sub {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Request a Ride
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form id="ride-request-form">
                        <!-- Ride Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock text-primary me-2"></i>Ride Type *
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="ride_type" id="immediate" value="immediate" checked>
                                        <label class="form-check-label" for="immediate">
                                            <i class="fas fa-bolt text-warning me-2"></i>Ride Now
                                            <small class="d-block text-muted">Get picked up immediately</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="ride_type" id="scheduled" value="scheduled">
                                        <label class="form-check-label" for="scheduled">
                                            <i class="fas fa-calendar-alt text-info me-2"></i>Schedule Ride
                                            <small class="d-block text-muted">Schedule for later</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduled Time (hidden by default) -->
                        <div class="mb-4 d-none" id="scheduled-time-section">
                            <label for="scheduled_pickup_time" class="form-label fw-bold">
                                <i class="fas fa-clock text-info me-2"></i>Pickup Time *
                            </label>
                            <input type="datetime-local" class="form-control" id="scheduled_pickup_time" name="scheduled_pickup_time">
                            <small class="form-text text-muted">Select when you want to be picked up</small>
                        </div>

                        <!-- Pickup Location -->
                        <div class="mb-4">
                            <label for="pickup_location" class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt text-success me-2"></i>Pickup Location *
                            </label>
                            <div class="input-group position-relative">
                                <input type="text" class="form-control" id="pickup_location" name="pickup_location" 
                                       placeholder="Enter pickup address (e.g., 123 Ikeja Road, Lagos)" required
                                       autocomplete="off">
                                <button class="btn btn-outline-secondary" type="button" onclick="getCurrentLocation('pickup')" title="Use current location">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                                <button class="btn btn-outline-primary" type="button" onclick="searchLocation('pickup')" title="Search location">
                                    <i class="fas fa-search"></i>
                                </button>
                                <!-- Suggestions dropdown -->
                                <div id="pickup-suggestions" class="suggestions-dropdown position-absolute w-100 bg-white border rounded shadow-sm d-none" style="top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                            <input type="hidden" id="pickup_latitude" name="pickup_latitude">
                            <input type="hidden" id="pickup_longitude" name="pickup_longitude">
                            <small class="form-text text-muted">Enter a full address for better accuracy</small>
                        </div>

                        <!-- Dropoff Location -->
                        <div class="mb-4">
                            <label for="dropoff_location" class="form-label fw-bold">
                                <i class="fas fa-flag text-danger me-2"></i>Dropoff Location *
                            </label>
                            <div class="input-group position-relative">
                                <input type="text" class="form-control" id="dropoff_location" name="dropoff_location" 
                                       placeholder="Enter destination address (e.g., 456 Victoria Island, Lagos)" required
                                       autocomplete="off">
                                <button class="btn btn-outline-primary" type="button" onclick="searchLocation('dropoff')" title="Search location">
                                    <i class="fas fa-search"></i>
                                </button>
                                <!-- Suggestions dropdown -->
                                <div id="dropoff-suggestions" class="suggestions-dropdown position-absolute w-100 bg-white border rounded shadow-sm d-none" style="top: 100%; z-index: 1000; max-height: 200px; overflow-y: auto;">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                            <input type="hidden" id="dropoff_latitude" name="dropoff_latitude">
                            <input type="hidden" id="dropoff_longitude" name="dropoff_longitude">
                            <small class="form-text text-muted">Enter a full address for better accuracy</small>
                        </div>

                        <!-- Interactive Map -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-map me-2"></i>Route Preview
                            </label>
                            <div class="map-container border rounded" style="height: 300px; position: relative;">
                                <div id="map" style="width: 100%; height: 100%;"></div>
                                <div id="map-placeholder" class="d-flex align-items-center justify-content-center h-100 bg-light text-center">
                                    <div>
                                        <i class="fas fa-map display-4 mb-3 text-muted"></i>
                                        <p class="text-muted">Interactive map will appear here</p>
                                        <small class="text-muted">Enter pickup and dropoff locations to see route</small>
                                    </div>
                                </div>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Map will show your route and estimated distance once locations are set
                            </small>
                        </div>

                        <!-- Ride Details -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-route text-primary mb-2"></i>
                                        <h6>Distance</h6>
                                        <p class="mb-0" id="estimated-distance">--</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-clock text-warning mb-2"></i>
                                        <h6>Duration</h6>
                                        <p class="mb-0" id="estimated-duration">--</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <i class="fas fa-dollar-sign text-success mb-2"></i>
                                        <h6>Estimated Fare</h6>
                                        <p class="mb-0" id="estimated-fare">--</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-credit-card text-success me-2"></i>Payment Method *
                            </label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="cash" value="cash" checked>
                                        <label class="form-check-label" for="cash">
                                            <i class="fas fa-money-bill-wave text-success me-2"></i>Cash
                                            <small class="d-block text-muted">Pay with cash upon completion</small>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" disabled>
                                        <label class="form-check-label text-muted" for="card">
                                            <i class="fas fa-credit-card text-muted me-2"></i>Credit/Debit Card
                                            <small class="d-block text-muted">Coming soon</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Notes -->
                        <div class="mb-4">
                            <label for="notes" class="form-label fw-bold">
                                <i class="fas fa-comment me-2"></i>Additional Notes (Optional)
                            </label>
                            <textarea class="form-control" id="notes" name="notes" rows="3" 
                                      placeholder="Any special instructions for the driver, incase offline input your contact"></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                <i class="fas fa-paper-plane me-2"></i>
                                <span id="submit-text">Request Ride</span>
                                <div class="spinner-border spinner-border-sm d-none" id="submit-spinner"></div>
                            </button>
                            <a href="/dashboard/" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="success-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>Ride Requested Successfully!
                </h5>
            </div>
            <div class="modal-body text-center py-4">
                <i class="fas fa-car text-success display-4 mb-3"></i>
                <h5>Your ride has been requested</h5>
                <p class="text-muted">We're looking for nearby drivers. You'll be notified when a driver accepts your ride.</p>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Ride ID:</strong> <span id="ride-id">--</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="goToDashboard()">
                    <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables for Google Maps
let map;
let pickupMarker;
let dropoffMarker;
let autocompletePickup;
let autocompleteDropoff;

// Initialize Google Maps
function initMap() {
    // Initialize map centered on Lagos, Nigeria
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: { lat: 6.5244, lng: 3.3792 }, // Lagos coordinates
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
    });

    // Initialize directions service and renderer
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({
        draggable: false,
        markerOptions: {
            animation: google.maps.Animation.DROP
        }
    });
    directionsRenderer.setMap(map);

    // Hide map placeholder
    document.getElementById('map-placeholder').style.display = 'none';
    document.getElementById('map').style.display = 'block';

    // Initialize autocomplete for pickup and dropoff inputs
    initializeAutocomplete();

    console.log('Google Maps initialized successfully');
}

function initializeAutocomplete() {
    const pickupInput = document.getElementById('pickup_location');
    const dropoffInput = document.getElementById('dropoff_location');

    // Create autocomplete instances with Nigerian bias
    const options = {
        componentRestrictions: { country: 'ng' }, // Restrict to Nigeria
        fields: ['place_id', 'geometry', 'name', 'formatted_address']
    };

    autocompletePickup = new google.maps.places.Autocomplete(pickupInput, options);
    autocompleteDropoff = new google.maps.places.Autocomplete(dropoffInput, options);

    // Add listeners for place selection
    autocompletePickup.addListener('place_changed', function() {
        const place = autocompletePickup.getPlace();
        if (place.geometry) {
            document.getElementById('pickup_latitude').value = place.geometry.location.lat();
            document.getElementById('pickup_longitude').value = place.geometry.location.lng();
            updateMapWithRoute();
        }
    });

    autocompleteDropoff.addListener('place_changed', function() {
        const place = autocompleteDropoff.getPlace();
        if (place.geometry) {
            document.getElementById('dropoff_latitude').value = place.geometry.location.lat();
            document.getElementById('dropoff_longitude').value = place.geometry.location.lng();
            updateMapWithRoute();
        }
    });
}

function updateMapWithRoute() {
    const pickupLat = parseFloat(document.getElementById('pickup_latitude').value);
    const pickupLng = parseFloat(document.getElementById('pickup_longitude').value);
    const dropoffLat = parseFloat(document.getElementById('dropoff_latitude').value);
    const dropoffLng = parseFloat(document.getElementById('dropoff_longitude').value);

    console.log('Updating map with route:', { pickupLat, pickupLng, dropoffLat, dropoffLng });

    // Clear existing route
    directionsRenderer.setDirections({ routes: [] });

    // If both locations are available, calculate and display route
    if (pickupLat && pickupLng && dropoffLat && dropoffLng && 
        !isNaN(pickupLat) && !isNaN(pickupLng) && !isNaN(dropoffLat) && !isNaN(dropoffLng)) {
        
        const pickup = new google.maps.LatLng(pickupLat, pickupLng);
        const dropoff = new google.maps.LatLng(dropoffLat, dropoffLng);

        const request = {
            origin: pickup,
            destination: dropoff,
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false
        };

        directionsService.route(request, function(result, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                
                // Update distance and duration info
                const route = result.routes[0];
                const leg = route.legs[0];
                updateRideInfo(leg.distance.text, leg.duration.text);
                
                console.log('Route calculated successfully:', {
                    distance: leg.distance.text,
                    duration: leg.duration.text
                });
            } else {
                console.error('Directions request failed due to:', status);
                showAlert('Could not calculate route. Please check your locations.', 'warning');
            }
        });
    } else if (pickupLat && pickupLng && !isNaN(pickupLat) && !isNaN(pickupLng)) {
        // Only pickup location available, center map on it
        map.setCenter(new google.maps.LatLng(pickupLat, pickupLng));
        map.setZoom(15);
    }
}

function updateRideInfo(distance, duration) {
    // Update the distance and duration display
    const distanceElement = document.querySelector('.route-distance');
    const durationElement = document.querySelector('.route-duration');
    
    if (distanceElement) {
        distanceElement.textContent = distance;
    }
    if (durationElement) {
        durationElement.textContent = duration;
    }

    // Calculate estimated fare based on distance
    const distanceValue = parseFloat(distance.replace(/[^\d.]/g, ''));
    const baseFare = 500; // Base fare in Naira
    const perKmRate = 150; // Rate per km in Naira
    const estimatedFare = baseFare + (distanceValue * perKmRate);
    
    const fareElement = document.querySelector('.estimated-fare');
    if (fareElement) {
        fareElement.textContent = `₦${estimatedFare.toLocaleString()}`;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Redirect if not authenticated
    if (!isAuthenticated()) {
        showAlert('Please login to request a ride', 'warning');
        setTimeout(() => {
            window.location.href = '/login/';
        }, 2000);
        return;
    }

    // Set up form submission
    document.getElementById('ride-request-form').addEventListener('submit', handleRideRequest);
    
    // Set up location change listeners with suggestions
    setupLocationSuggestions('pickup');
    setupLocationSuggestions('dropoff');
    
    // Set up ride type radio button listeners
    document.getElementById('immediate').addEventListener('change', handleRideTypeChange);
    document.getElementById('scheduled').addEventListener('change', handleRideTypeChange);
    
    // Set minimum datetime for scheduled rides (30 minutes from now)
    const now = new Date();
    now.setMinutes(now.getMinutes() + 30);
    document.getElementById('scheduled_pickup_time').min = now.toISOString().slice(0, 16);
    
    // Initialize map based on available technology
    if (window.useGoogleMaps && typeof google !== 'undefined') {
        console.log('Google Maps API loaded, will initialize via callback');
    } else {
        console.log('Using Leaflet fallback map');
        // Force initialization of Leaflet map after a small delay to ensure DOM is ready
        setTimeout(() => {
            if (!map) {
                initFallbackMap();
            }
        }, 100);
    }

    // Close suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.input-group')) {
            hideSuggestions('pickup');
            hideSuggestions('dropoff');
        }
    });
});

async function handleRideRequest(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitSpinner = document.getElementById('submit-spinner');
    
    // Validate form
    if (!validateRideForm()) {
        return;
    }
    
    // Show loading state
    submitText.textContent = 'Requesting Ride...';
    submitSpinner.classList.remove('d-none');
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(e.target);
        const isScheduled = formData.get('ride_type') === 'scheduled';
        const rideData = {
            pickup_location: formData.get('pickup_location'),
            pickup_latitude: formatCoordinate(formData.get('pickup_latitude')),
            pickup_longitude: formatCoordinate(formData.get('pickup_longitude')),
            dropoff_location: formData.get('dropoff_location'),
            dropoff_latitude: formatCoordinate(formData.get('dropoff_latitude')),
            dropoff_longitude: formatCoordinate(formData.get('dropoff_longitude')),
            is_scheduled: isScheduled,
            scheduled_pickup_time: isScheduled ? formData.get('scheduled_pickup_time') : null,
            payment_method: formData.get('payment_method'),
            notes: formData.get('notes') || ''
        };
        
        console.log('Sending ride data:', rideData);
        
        const response = await makeAuthenticatedRequest('/api/', {
            method: 'POST',
            body: JSON.stringify(rideData)
        });
        
        if (response.ok) {
            const result = await response.json();
            document.getElementById('ride-id').textContent = result.id;
            
            // Show success modal
            const modal = new bootstrap.Modal(document.getElementById('success-modal'));
            modal.show();
            
            // Reset form
            e.target.reset();
            clearEstimates();
            
        } else {
            const errorData = await response.json();
            console.log('Error response:', errorData);
            
            // Handle Django validation errors
            let errorMessage = 'Failed to request ride';
            if (errorData.message) {
                errorMessage = errorData.message;
            } else if (typeof errorData === 'object') {
                // Handle Django field validation errors
                const errorMessages = [];
                for (const [field, errors] of Object.entries(errorData)) {
                    if (Array.isArray(errors)) {
                        errorMessages.push(`${field}: ${errors.join(', ')}`);
                    } else {
                        errorMessages.push(`${field}: ${errors}`);
                    }
                }
                if (errorMessages.length > 0) {
                    errorMessage = errorMessages.join('; ');
                }
            }
            throw new Error(errorMessage);
        }
        
    } catch (error) {
        console.error('Error requesting ride:', error);
        showAlert(error.message || 'Error requesting ride. Please try again.', 'danger');
    } finally {
        // Reset button state
        submitText.textContent = 'Request Ride';
        submitSpinner.classList.add('d-none');
        submitBtn.disabled = false;
    }
}

function validateRideForm() {
    const pickupLocation = document.getElementById('pickup_location').value.trim();
    const dropoffLocation = document.getElementById('dropoff_location').value.trim();
    const pickupLat = parseFloat(document.getElementById('pickup_latitude').value);
    const pickupLng = parseFloat(document.getElementById('pickup_longitude').value);
    const dropoffLat = parseFloat(document.getElementById('dropoff_latitude').value);
    const dropoffLng = parseFloat(document.getElementById('dropoff_longitude').value);
    const isScheduled = document.getElementById('scheduled').checked;
    const scheduledTime = document.getElementById('scheduled_pickup_time').value;
    
    if (!pickupLocation) {
        showAlert('Please enter a pickup location', 'warning');
        document.getElementById('pickup_location').focus();
        return false;
    }
    
    if (!dropoffLocation) {
        showAlert('Please enter a dropoff location', 'warning');
        document.getElementById('dropoff_location').focus();
        return false;
    }
    
    // Validate scheduled time if scheduled ride is selected
    if (isScheduled) {
        if (!scheduledTime) {
            showAlert('Please select a pickup time for scheduled ride', 'warning');
            document.getElementById('scheduled_pickup_time').focus();
            return false;
        }
        
        const scheduledDate = new Date(scheduledTime);
        const now = new Date();
        const minTime = new Date(now.getTime() + 30 * 60000); // 30 minutes from now
        
        if (scheduledDate <= minTime) {
            showAlert('Scheduled pickup time must be at least 30 minutes from now', 'warning');
            document.getElementById('scheduled_pickup_time').focus();
            return false;
        }
    }
    
    // If coordinates are missing, require user to search for locations
    if (!pickupLat || !pickupLng) {
        showAlert('Please search for pickup location to get coordinates', 'warning');
        document.getElementById('pickup_location').focus();
        return false;
    }
    
    if (!dropoffLat || !dropoffLng) {
        showAlert('Please search for dropoff location to get coordinates', 'warning');
        document.getElementById('dropoff_location').focus();
        return false;
    }
    
    if (pickupLocation.toLowerCase() === dropoffLocation.toLowerCase()) {
        showAlert('Pickup and dropoff locations cannot be the same', 'warning');
        return false;
    }
    
    return true;
}

// Handle location input changes
function handleLocationInput() {
    const pickupLocation = document.getElementById('pickup_location').value.trim();
    const dropoffLocation = document.getElementById('dropoff_location').value.trim();
    
    // Auto-search if both locations have some text
    if (pickupLocation.length > 3 && dropoffLocation.length > 3) {
        autoGeocodeAndShowRoute();
    }
}

// Debounce function to limit API calls
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Auto-geocode both locations and show route
async function autoGeocodeAndShowRoute() {
    const pickupLocation = document.getElementById('pickup_location').value.trim();
    const dropoffLocation = document.getElementById('dropoff_location').value.trim();
    
    try {
        // Geocode both locations
        const [pickupCoords, dropoffCoords] = await Promise.all([
            geocodeAddress(pickupLocation),
            geocodeAddress(dropoffLocation)
        ]);
        
        // Set coordinates
        document.getElementById('pickup_latitude').value = formatCoordinate(pickupCoords.latitude);
        document.getElementById('pickup_longitude').value = formatCoordinate(pickupCoords.longitude);
        document.getElementById('dropoff_latitude').value = formatCoordinate(dropoffCoords.latitude);
        document.getElementById('dropoff_longitude').value = formatCoordinate(dropoffCoords.longitude);
        
        // Update estimates and map
        updateEstimates();
        updateMap();
        
    } catch (error) {
        console.log('Auto-geocoding failed:', error);
        // Don't show error to user for auto-geocoding
    }
}

// Helper function to format coordinates to 6 decimal places
function formatCoordinate(coord) {
    return parseFloat(parseFloat(coord).toFixed(6));
}

async function getCurrentLocation(type) {
    try {
        showAlert('Getting your current location...', 'info', 3000);
        
        // Try to get actual location first
        let location;
        try {
            location = await getUserLocation();
        } catch (error) {
            // Fallback to Lagos coordinates if geolocation fails
            location = { latitude: 6.5244, longitude: 3.3792 };
            console.log('Using fallback Lagos coordinates');
        }
        
        // For demo purposes, we'll use a simple address format
        const mockAddress = `Current Location (${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)})`;
        
        if (type === 'pickup') {
            document.getElementById('pickup_location').value = mockAddress;
            document.getElementById('pickup_latitude').value = formatCoordinate(location.latitude);
            document.getElementById('pickup_longitude').value = formatCoordinate(location.longitude);
        }
        
        updateEstimates();
        updateMap();
        showAlert('Location updated successfully', 'success', 2000);
        
    } catch (error) {
        console.error('Error getting location:', error);
        showAlert('Unable to get your location. Please enter it manually.', 'warning');
    }
}

function updateEstimates() {
    const pickupLat = parseFloat(document.getElementById('pickup_latitude').value);
    const pickupLng = parseFloat(document.getElementById('pickup_longitude').value);
    const dropoffLat = parseFloat(document.getElementById('dropoff_latitude').value);
    const dropoffLng = parseFloat(document.getElementById('dropoff_longitude').value);
    
    if (pickupLat && pickupLng && dropoffLat && dropoffLng) {
        // Calculate estimates
        const distance = calculateDistance(pickupLat, pickupLng, dropoffLat, dropoffLng);
        const duration = Math.round(distance * 2.5); // Rough estimate: 2.5 minutes per km
        const baseFare = 500.00; // Base fare in Nigerian Naira
        const perKmRate = 200.00; // Rate per km in Nigerian Naira
        const fare = baseFare + (distance * perKmRate);
        
        document.getElementById('estimated-distance').textContent = `${distance.toFixed(2)} km`;
        document.getElementById('estimated-duration').textContent = `${duration} min`;
        document.getElementById('estimated-fare').textContent = `₦${fare.toFixed(2)}`;
        
        // Update map if available
        updateMap();
    } else {
        clearEstimates();
    }
}

function clearEstimates() {
    document.getElementById('estimated-distance').textContent = '--';
    document.getElementById('estimated-duration').textContent = '--';
    document.getElementById('estimated-fare').textContent = '--';
}

function goToDashboard() {
    window.location.href = '/dashboard/';
}

// Handle ride type change (immediate vs scheduled)
function handleRideTypeChange() {
    const isScheduled = document.getElementById('scheduled').checked;
    const scheduledSection = document.getElementById('scheduled-time-section');
    const scheduledInput = document.getElementById('scheduled_pickup_time');
    
    if (isScheduled) {
        scheduledSection.classList.remove('d-none');
        scheduledInput.required = true;
    } else {
        scheduledSection.classList.add('d-none');
        scheduledInput.required = false;
        scheduledInput.value = '';
    }
}

// Enhanced location search function
async function searchLocation(type) {
    const locationInput = document.getElementById(`${type}_location`);
    const address = locationInput.value.trim();
    
    if (!address) {
        showAlert('Please enter an address to search', 'warning');
        return;
    }
    
    try {
        showAlert('Searching for location...', 'info', 3000);
        
        // Use geocoding service (mock implementation)
        const coords = await geocodeAddress(address);
        
        // Set the coordinates
        document.getElementById(`${type}_latitude`).value = formatCoordinate(coords.latitude);
        document.getElementById(`${type}_longitude`).value = formatCoordinate(coords.longitude);
        
        // Keep the original address, don't modify it
        // locationInput.value remains as user entered
        
        updateEstimates();
        updateMap();
        showAlert('Location coordinates found successfully', 'success', 2000);
        
    } catch (error) {
        console.error('Error searching location:', error);
        showAlert('Unable to find location. Please check the address.', 'warning');
    }
}

// Initialize Google Maps
let directionsService = null;
let directionsRenderer = null;

// Global flag to determine which map system to use
window.useGoogleMaps = false;

function initMap() {
    if (!window.useGoogleMaps || typeof google === 'undefined') {
        console.log('Google Maps not available, using fallback map');
        initFallbackMap();
        return;
    }
    
    try {
        // Initialize Google Maps
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 6.5244, lng: 3.3792 },
            zoom: 12,
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            styles: [
                {
                    featureType: 'poi',
                    elementType: 'labels',
                    stylers: [{ visibility: 'off' }]
                }
            ]
        });

        // Initialize directions service and renderer
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            draggable: false,
            suppressMarkers: false,
            polylineOptions: {
                strokeColor: '#007bff',
                strokeWeight: 4,
                strokeOpacity: 0.8
            }
        });
        directionsRenderer.setMap(map);

        // Initialize Places Autocomplete for location inputs
        initializeAutocomplete();

        // Hide placeholder when map is ready
        document.getElementById('map-placeholder').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        console.log('Google Maps initialized successfully');
        
    } catch (error) {
        console.error('Error initializing Google Maps:', error);
        window.useGoogleMaps = false;
        initFallbackMap();
    }
}

function initFallbackMapSimple() {
    try {
        // Initialize basic Leaflet map without routing
        map = L.map('map').setView([6.5244, 3.3792], 12);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Initialize global variables for Leaflet
        window.leafletControl = null;
        window.leafletMarkers = [];
        
        // Hide placeholder when map is ready
        document.getElementById('map-placeholder').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        console.log('Basic Leaflet map initialized successfully (without routing)');
        
    } catch (error) {
        console.error('Error initializing basic fallback map:', error);
        showMapError();
    }
}

function showMapError() {
    const placeholder = document.getElementById('map-placeholder');
    if (placeholder) {
        placeholder.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle display-4 mb-3 text-warning"></i>
                <p class="text-muted">Map temporarily unavailable</p>
                <small class="text-muted">You can still request rides - route information will be calculated</small>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="retryMapInit()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        `;
        placeholder.style.display = 'flex';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
    }
}

function retryMapInit() {
    console.log('Retrying map initialization...');
    window.leafletInitAttempts = 0;
    document.getElementById('map-placeholder').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin display-4 mb-3 text-primary"></i>
            <p class="text-muted">Loading map...</p>
        </div>
    `;
    checkLeafletAndInit();
}

function initFallbackMap() {
    // Wait for Leaflet and routing to be available
    if (typeof L === 'undefined') {
        console.log('Waiting for Leaflet to load...');
        setTimeout(initFallbackMap, 100);
        return;
    }
    
    if (typeof L.Routing === 'undefined') {
        console.log('Waiting for Leaflet Routing Machine to load...');
        setTimeout(initFallbackMap, 100);
        return;
    }
    
    try {
        // Initialize Leaflet map
        map = L.map('map').setView([6.5244, 3.3792], 12);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Initialize global variables for Leaflet
        window.leafletControl = null;
        window.leafletMarkers = [];
        
        // Hide placeholder when map is ready
        document.getElementById('map-placeholder').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        console.log('Leaflet fallback map initialized successfully');
        
    } catch (error) {
        console.error('Error initializing fallback map:', error);
        // Show placeholder with error message
        const placeholder = document.getElementById('map-placeholder');
        placeholder.innerHTML = `
            <div class="text-center">
                <i class="fas fa-map-marked-alt display-4 mb-3 text-muted"></i>
                <p class="text-muted">Map temporarily unavailable</p>
                <small class="text-muted">Route information will still be calculated</small>
            </div>
        `;
    }
}

function initFallbackMapSimple() {
    try {
        // Initialize basic Leaflet map without routing
        map = L.map('map').setView([6.5244, 3.3792], 12);
        
        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Initialize global variables for Leaflet
        window.leafletControl = null;
        window.leafletMarkers = [];
        
        // Hide placeholder when map is ready
        document.getElementById('map-placeholder').style.display = 'none';
        document.getElementById('map').style.display = 'block';
        
        console.log('Basic Leaflet map initialized successfully (without routing)');
        
    } catch (error) {
        console.error('Error initializing basic fallback map:', error);
        showMapError();
    }
}

function showMapError() {
    const placeholder = document.getElementById('map-placeholder');
    if (placeholder) {
        placeholder.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle display-4 mb-3 text-warning"></i>
                <p class="text-muted">Map temporarily unavailable</p>
                <small class="text-muted">You can still request rides - route information will be calculated</small>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="retryMapInit()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        `;
        placeholder.style.display = 'flex';
        placeholder.style.alignItems = 'center';
        placeholder.style.justifyContent = 'center';
    }
}

function retryMapInit() {
    console.log('Retrying map initialization...');
    window.leafletInitAttempts = 0;
    document.getElementById('map-placeholder').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin display-4 mb-3 text-primary"></i>
            <p class="text-muted">Loading map...</p>
        </div>
    `;
    checkLeafletAndInit();
}

// ...existing code...

function updateMap() {
    if (!map) {
        console.log('Map not initialized, trying to initialize...');
        if (window.useGoogleMaps && typeof google !== 'undefined') {
            initMap();
        } else {
            initFallbackMap();
        }
        // Wait for map to initialize then update
        setTimeout(() => {
            if (map) {
                updateMap();
            }
        }, 500);
        return;
    }
    
    const pickupLat = parseFloat(document.getElementById('pickup_latitude').value);
    const pickupLng = parseFloat(document.getElementById('pickup_longitude').value);
    const dropoffLat = parseFloat(document.getElementById('dropoff_latitude').value);
    const dropoffLng = parseFloat(document.getElementById('dropoff_longitude').value);
    
    console.log('Updating map with coordinates:', { pickupLat, pickupLng, dropoffLat, dropoffLng });
    
    if (window.useGoogleMaps && typeof google !== 'undefined') {
        updateGoogleMap(pickupLat, pickupLng, dropoffLat, dropoffLng);
    } else {
        updateLeafletMap(pickupLat, pickupLng, dropoffLat, dropoffLng);
    }
}

function updateGoogleMap(pickupLat, pickupLng, dropoffLat, dropoffLng) {
    // Clear existing markers
    if (pickupMarker) {
        pickupMarker.setMap(null);
        pickupMarker = null;
    }
    if (dropoffMarker) {
        dropoffMarker.setMap(null);
        dropoffMarker = null;
    }
    
    // Clear existing route
    if (directionsRenderer) {
        directionsRenderer.setDirections({ routes: [] });
    }
    
    const bounds = new google.maps.LatLngBounds();
    let hasValidCoordinates = false;
    
    // Add pickup marker
    if (pickupLat && pickupLng && !isNaN(pickupLat) && !isNaN(pickupLng)) {
        const pickupPos = { lat: pickupLat, lng: pickupLng };
        pickupMarker = new google.maps.Marker({
            position: pickupPos,
            map: map,
            title: 'Pickup Location',
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        const pickupInfoWindow = new google.maps.InfoWindow({
            content: '<strong>Pickup Location</strong><br>' + document.getElementById('pickup_location').value
        });
        
        pickupMarker.addListener('click', () => {
            pickupInfoWindow.open(map, pickupMarker);
        });
        
        bounds.extend(pickupPos);
        hasValidCoordinates = true;
        console.log('Added pickup marker at:', pickupLat, pickupLng);
    }
    
    // Add dropoff marker
    if (dropoffLat && dropoffLng && !isNaN(dropoffLat) && !isNaN(dropoffLng)) {
        const dropoffPos = { lat: dropoffLat, lng: dropoffLng };
        dropoffMarker = new google.maps.Marker({
            position: dropoffPos,
            map: map,
            title: 'Dropoff Location',
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            }
        });
        
        const dropoffInfoWindow = new google.maps.InfoWindow({
            content: '<strong>Dropoff Location</strong><br>' + document.getElementById('dropoff_location').value
        });
        
        dropoffMarker.addListener('click', () => {
            dropoffInfoWindow.open(map, dropoffMarker);
        });
        
        bounds.extend(dropoffPos);
        hasValidCoordinates = true;
        console.log('Added dropoff marker at:', dropoffLat, dropoffLng);
    }
    
    // Draw route if both points exist
    if (pickupMarker && dropoffMarker) {
        const request = {
            origin: pickupMarker.getPosition(),
            destination: dropoffMarker.getPosition(),
            travelMode: google.maps.TravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false
        };
        
        directionsService.route(request, (result, status) => {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                console.log('Route displayed successfully');
                
                // Calculate and display route info
                const route = result.routes[0];
                const leg = route.legs[0];
                const distance = leg.distance.text;
                const duration = leg.duration.text;
                
                console.log(`Route: ${distance}, ${duration}`);
                
                // Update fare calculation with route distance
                updateFareEstimate(leg.distance.value, leg.duration.value);
            } else {
                console.error('Directions request failed due to ' + status);
                // Fall back to fitting bounds if route fails
                if (hasValidCoordinates) {
                    map.fitBounds(bounds, { padding: 50 });
                }
                // Use straight-line distance for fare calculation
                if (pickupLat && pickupLng && dropoffLat && dropoffLng) {
                    const distance = calculateDistance(pickupLat, pickupLng, dropoffLat, dropoffLng);
                    updateFareEstimateFromDistance(distance);
                }
            }
        });
    } else if (hasValidCoordinates) {
        // Center on available markers
        map.fitBounds(bounds, { padding: 50 });
        console.log('Centered on available markers');
    }
}

function updateLeafletMap(pickupLat, pickupLng, dropoffLat, dropoffLng) {
    // Check if Leaflet is available
    if (typeof L === 'undefined') {
        console.log('Leaflet not yet available, waiting...');
        setTimeout(() => updateLeafletMap(pickupLat, pickupLng, dropoffLat, dropoffLng), 100);
        return;
    }
    
    // Clear existing markers and routing control
    if (window.leafletMarkers && window.leafletMarkers.length > 0) {
        window.leafletMarkers.forEach(marker => {
            map.removeLayer(marker);
        });
        window.leafletMarkers = [];
    }
    
    if (window.leafletControl) {
        map.removeControl(window.leafletControl);
        window.leafletControl = null;
    }
    
    if (window.leafletRouteLine) {
        map.removeLayer(window.leafletRouteLine);
        window.leafletRouteLine = null;
    }
    
    const validPickup = pickupLat && pickupLng && !isNaN(pickupLat) && !isNaN(pickupLng);
    const validDropoff = dropoffLat && dropoffLng && !isNaN(dropoffLat) && !isNaN(dropoffLng);
    
    // Add pickup marker
    if (validPickup) {
        const pickupMarker = L.marker([pickupLat, pickupLng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        pickupMarker.bindPopup('<strong>Pickup Location</strong><br>' + document.getElementById('pickup_location').value);
        window.leafletMarkers.push(pickupMarker);
        console.log('Added pickup marker at:', pickupLat, pickupLng);
    }
    
    // Add dropoff marker
    if (validDropoff) {
        const dropoffMarker = L.marker([dropoffLat, dropoffLng], {
            icon: L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).addTo(map);
        
        dropoffMarker.bindPopup('<strong>Dropoff Location</strong><br>' + document.getElementById('dropoff_location').value);
        window.leafletMarkers.push(dropoffMarker);
        console.log('Added dropoff marker at:', dropoffLat, dropoffLng);
    }
    
    // Create route if both points exist and routing is available
    if (validPickup && validDropoff && typeof L.Routing !== 'undefined') {
        try {
            window.leafletControl = L.Routing.control({
                waypoints: [
                    L.latLng(pickupLat, pickupLng),
                    L.latLng(dropoffLat, dropoffLng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function() { return null; }, // Don't create default markers
                lineOptions: {
                    styles: [{ color: '#007bff', weight: 4, opacity: 0.7 }]
                }
            }).on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                // Distance in meters, duration in seconds
                const distanceKm = summary.totalDistance / 1000;
                const durationMin = Math.round(summary.totalTime / 60);
                
                console.log(`Leaflet route found: ${distanceKm.toFixed(1)} km, ${durationMin} min`);
                
                // Update fare estimate
                updateFareEstimate(summary.totalDistance, summary.totalTime);
                
            }).addTo(map);
            
            console.log('Leaflet routing control added successfully');
            
        } catch (error) {
            console.error('Error creating Leaflet route:', error);
            // Fall back to simple line if routing fails
            addSimpleRouteLine(pickupLat, pickupLng, dropoffLat, dropoffLng);
        }
    } else if (validPickup && validDropoff) {
        // Routing not available, use simple line
        console.log('Routing library not available, using simple line');
        addSimpleRouteLine(pickupLat, pickupLng, dropoffLat, dropoffLng);
    } else if (window.leafletMarkers.length > 0) {
        // Fit map to show available markers
        if (window.leafletMarkers.length === 1) {
            map.setView(window.leafletMarkers[0].getLatLng(), 15);
        } else {
            const group = new L.featureGroup(window.leafletMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
        console.log('Centered map on available markers');
    }
}

function addSimpleRouteLine(pickupLat, pickupLng, dropoffLat, dropoffLng) {
    // Add simple straight line route
    const routeLine = L.polyline([[pickupLat, pickupLng], [dropoffLat, dropoffLng]], {
        color: '#007bff',
        weight: 4,
        opacity: 0.7,
        dashArray: '10, 5' // Dashed line to indicate it's not a real route
    }).addTo(map);
    
    // Store reference for cleanup
    window.leafletRouteLine = routeLine;
    
    // Fit map to show both markers with padding
    const group = new L.featureGroup(window.leafletMarkers);
    map.fitBounds(group.getBounds().pad(0.1));
    
    // Calculate distance and update fare
    const distance = calculateDistance(pickupLat, pickupLng, dropoffLat, dropoffLng);
    updateFareEstimateFromDistance(distance);
    
    console.log('Added simple route line (no real routing available)');
}

function addSimpleRouteLine(pickupLat, pickupLng, dropoffLat, dropoffLng) {
    // Add simple straight line route
    const routeLine = L.polyline([[pickupLat, pickupLng], [dropoffLat, dropoffLng]], {
        color: '#007bff',
        weight: 4,
        opacity: 0.7,
        dashArray: '10, 5' // Dashed line to indicate it's not a real route
    }).addTo(map);
    
    // Store reference for cleanup
    window.leafletRouteLine = routeLine;
    
    // Fit map to show both markers with padding
    const group = new L.featureGroup(window.leafletMarkers);
    map.fitBounds(group.getBounds().pad(0.1));
    
    // Calculate distance and update fare
    const distance = calculateDistance(pickupLat, pickupLng, dropoffLat, dropoffLng);
    updateFareEstimateFromDistance(distance);
    
    console.log('Added simple route line (no real routing available)');
}

// Helper function to resolve address to coordinates using Google Geocoding API or fallback
function geocodeAddress(address) {
    return new Promise((resolve, reject) => {
        if (!address) {
            return reject(new Error('Address is required for geocoding'));
        }
        
        // First, try to use the Google Geocoding API
        if (window.useGoogleMaps && typeof google !== 'undefined') {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({
                address: address,
                componentRestrictions: { country: 'NG' },
                region: 'NG'
            }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    resolve({
                        latitude: location.lat(),
                        longitude: location.lng(),
                        formatted_address: results[0].formatted_address
                    });
                } else {
                    console.log('Google geocoding failed, using fallback');
                    resolveFallbackLocation(address, resolve);
                }
            });
        } else {
            // Use fallback geocoding
            resolveFallbackLocation(address, resolve);
        }
    });
}

function resolveFallbackLocation(address, resolve) {
    // Fallback to Nigerian locations database
    const fallbackLocations = {
        'lagos': { latitude: 6.5244, longitude: 3.3792 },
        'ikeja': { latitude: 6.6018, longitude: 3.3515 },
        'victoria island': { latitude: 6.4281, longitude: 3.4219 },
        'ikoyi': { latitude: 6.4474, longitude: 3.4323 },
        'surulere': { latitude: 6.4969, longitude: 3.3654 },
        'yaba': { latitude: 6.5158, longitude: 3.3707 },
        'lekki': { latitude: 6.4698, longitude: 3.5852 },
        'ajah': { latitude: 6.4698, longitude: 3.6043 },
        'maryland': { latitude: 6.5568, longitude: 3.3724 },
        'gbagada': { latitude: 6.5568, longitude: 3.3835 },
        'abuja': { latitude: 9.0765, longitude: 7.3986 },
        'kano': { latitude: 12.0022, longitude: 8.5920 },
        'port harcourt': { latitude: 4.8156, longitude: 7.0498 },
        'ibadan': { latitude: 7.3775, longitude: 3.9470 }
    };
    
    const searchLower = address.toLowerCase();
    for (const [key, coords] of Object.entries(fallbackLocations)) {
        if (searchLower.includes(key)) {
            resolve({
                latitude: coords.latitude + (Math.random() - 0.5) * 0.001,
                longitude: coords.longitude + (Math.random() - 0.5) * 0.001,
                formatted_address: address
            });
            return;
        }
    }
    
    // Default to Lagos if nothing matches
    resolve({
        latitude: 6.5244 + (Math.random() - 0.5) * 0.05,
        longitude: 3.3792 + (Math.random() - 0.5) * 0.05,
        formatted_address: address
    });
}

// Helper function to calculate distance between two coordinates (Haversine formula)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Radius of the Earth in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in kilometers
}

// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func.apply(this, args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function formatCoordinate(coord) {
    return parseFloat(coord).toFixed(6);
}

function showAlert(message, type = 'success', duration = 3000) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto remove after duration
    if (duration > 0) {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, duration);
    }
}

function formatCoordinate(coord) {
    return parseFloat(coord).toFixed(6);
}

function showAlert(message, type = 'success', duration = 3000) {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto remove after duration
    if (duration > 0) {
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, duration);
    }
}

// Nigerian locations database for suggestions
const nigerianLocations = [
    // Lagos State
    { name: 'Ikeja', state: 'Lagos', fullName: 'Ikeja, Lagos State', coords: { latitude: 6.6018, longitude: 3.3515 }},
    { name: 'Victoria Island', state: 'Lagos', fullName: 'Victoria Island, Lagos State', coords: { latitude: 6.4281, longitude: 3.4219 }},
    { name: 'Ikoyi', state: 'Lagos', fullName: 'Ikoyi, Lagos State', coords: { latitude: 6.4474, longitude: 3.4323 }},
    { name: 'Surulere', state: 'Lagos', fullName: 'Surulere, Lagos State', coords: { latitude: 6.4969, longitude: 3.3654 }},
    { name: 'Yaba', state: 'Lagos', fullName: 'Yaba, Lagos State', coords: { latitude: 6.5158, longitude: 3.3707 }},
    { name: 'Lekki', state: 'Lagos', fullName: 'Lekki, Lagos State', coords: { latitude: 6.4698, longitude: 3.5852 }},
    { name: 'Ajah', state: 'Lagos', fullName: 'Ajah, Lagos State', coords: { latitude: 6.4698, longitude: 3.6043 }},
    { name: 'Maryland', state: 'Lagos', fullName: 'Maryland, Lagos State', coords: { latitude: 6.5568, longitude: 3.3724 }},
    { name: 'Gbagada', state: 'Lagos', fullName: 'Gbagada, Lagos State', coords: { latitude: 6.5568, longitude: 3.3835 }},
    { name: 'Magodo', state: 'Lagos', fullName: 'Magodo, Lagos State', coords: { latitude: 6.6017, longitude: 3.3799 }},
    { name: 'Oregun', state: 'Lagos', fullName: 'Oregun, Lagos State', coords: { latitude: 6.5568, longitude: 3.3724 }},
    { name: 'Apapa', state: 'Lagos', fullName: 'Apapa, Lagos State', coords: { latitude: 6.4474, longitude: 3.3594 }},
    { name: 'Lagos Island', state: 'Lagos', fullName: 'Lagos Island, Lagos State', coords: { latitude: 6.4541, longitude: 3.3947 }},
    { name: 'Mushin', state: 'Lagos', fullName: 'Mushin, Lagos State', coords: { latitude: 6.5244, longitude: 3.3452 }},
    { name: 'Oshodi', state: 'Lagos', fullName: 'Oshodi, Lagos State', coords: { latitude: 6.5492, longitude: 3.3348 }},
    { name: 'Alaba', state: 'Lagos', fullName: 'Alaba, Lagos State', coords: { latitude: 6.4641, longitude: 3.1794 }},
    { name: 'Isolo', state: 'Lagos', fullName: 'Isolo, Lagos State', coords: { latitude: 6.5244, longitude: 3.3267 }},
    { name: 'Ketu', state: 'Lagos', fullName: 'Ketu, Lagos State', coords: { latitude: 6.6018, longitude: 3.3903 }},
    { name: 'Mile 12', state: 'Lagos', fullName: 'Mile 12, Lagos State', coords: { latitude: 6.6267, longitude: 3.3903 }},
    { name: 'Ojota', state: 'Lagos', fullName: 'Ojota, Lagos State', coords: { latitude: 6.5568, longitude: 3.3903 }},
    
    // FCT Abuja
    { name: 'Wuse', state: 'FCT', fullName: 'Wuse, Abuja FCT', coords: { latitude: 9.0579, longitude: 7.4951 }},
    { name: 'Garki', state: 'FCT', fullName: 'Garki, Abuja FCT', coords: { latitude: 9.0579, longitude: 7.4951 }},
    { name: 'Maitama', state: 'FCT', fullName: 'Maitama, Abuja FCT', coords: { latitude: 9.0579, longitude: 7.4951 }},
    { name: 'Gwarinpa', state: 'FCT', fullName: 'Gwarinpa, Abuja FCT', coords: { latitude: 9.1579, longitude: 7.4951 }},
    { name: 'Kubwa', state: 'FCT', fullName: 'Kubwa, Abuja FCT', coords: { latitude: 9.1579, longitude: 7.3451 }},
    { name: 'Nyanya', state: 'FCT', fullName: 'Nyanya, Abuja FCT', coords: { latitude: 8.9579, longitude: 7.4951 }},
    
    // Other major cities
    { name: 'Kano', state: 'Kano', fullName: 'Kano, Kano State', coords: { latitude: 12.0022, longitude: 8.5920 }},
    { name: 'Port Harcourt', state: 'Rivers', fullName: 'Port Harcourt, Rivers State', coords: { latitude: 4.8156, longitude: 7.0498 }},
    { name: 'Ibadan', state: 'Oyo', fullName: 'Ibadan, Oyo State', coords: { latitude: 7.3775, longitude: 3.9470 }},
    { name: 'Benin City', state: 'Edo', fullName: 'Benin City, Edo State', coords: { latitude: 6.3350, longitude: 5.6037 }},
    { name: 'Enugu', state: 'Enugu', fullName: 'Enugu, Enugu State', coords: { latitude: 6.5244, longitude: 7.5086 }},
    { name: 'Kaduna', state: 'Kaduna', fullName: 'Kaduna, Kaduna State', coords: { latitude: 10.5222, longitude: 7.4383 }},
    { name: 'Jos', state: 'Plateau', fullName: 'Jos, Plateau State', coords: { latitude: 9.8965, longitude: 8.8583 }},
    { name: 'Warri', state: 'Delta', fullName: 'Warri, Delta State', coords: { latitude: 5.5160, longitude: 5.7500 }},
    { name: 'Calabar', state: 'Cross River', fullName: 'Calabar, Cross River State', coords: { latitude: 4.9517, longitude: 8.3220 }},
    { name: 'Uyo', state: 'Akwa Ibom', fullName: 'Uyo, Akwa Ibom State', coords: { latitude: 5.0104, longitude: 7.8584 }},
    { name: 'Osun', state: 'Osun', fullName: 'Osogbo, Osun State', coords: { latitude: 7.7699, longitude: 4.5569 }},
    { name: 'Abeokuta', state: 'Ogun', fullName: 'Abeokuta, Ogun State', coords: { latitude: 7.1607, longitude: 3.3500 }},
    { name: 'Ilorin', state: 'Kwara', fullName: 'Ilorin, Kwara State', coords: { latitude: 8.4916, longitude: 4.5481 }},
    { name: 'Maiduguri', state: 'Borno', fullName: 'Maiduguri, Borno State', coords: { latitude: 11.8451, longitude: 13.1570 }},
    { name: 'Yola', state: 'Adamawa', fullName: 'Yola, Adamawa State', coords: { latitude: 9.2035, longitude: 12.4852 }},
    { name: 'Sokoto', state: 'Sokoto', fullName: 'Sokoto, Sokoto State', coords: { latitude: 13.0645, longitude: 5.2483 }},
    { name: 'Zaria', state: 'Kaduna', fullName: 'Zaria, Kaduna State', coords: { latitude: 11.1111, longitude: 7.7222 }},
    { name: 'Aba', state: 'Abia', fullName: 'Aba, Abia State', coords: { latitude: 5.1050, longitude: 7.3667 }},
    { name: 'Onitsha', state: 'Anambra', fullName: 'Onitsha, Anambra State', coords: { latitude: 6.1500, longitude: 6.8000 }},
    { name: 'Owerri', state: 'Imo', fullName: 'Owerri, Imo State', coords: { latitude: 5.4833, longitude: 7.0333 }}
];

// Setup location suggestions
function setupLocationSuggestions(type) {
    const input = document.getElementById(`${type}_location`);
    const suggestions = document.getElementById(`${type}-suggestions`);
    
    input.addEventListener('input', debounce(function() {
        const query = input.value.trim();
        if (query.length >= 2) {
            showLocationSuggestions(type, query);
        } else {
            hideSuggestions(type);
        }
    }, 300));
    
    input.addEventListener('focus', function() {
        const query = input.value.trim();
        if (query.length >= 2) {
            showLocationSuggestions(type, query);
        }
    });
    
    input.addEventListener('keydown', function(e) {
        handleSuggestionNavigation(e, type);
    });
}

function showLocationSuggestions(type, query) {
    const suggestions = document.getElementById(`${type}-suggestions`);
    const matches = findLocationMatches(query);
    
    if (matches.length === 0) {
        hideSuggestions(type);
        return;
    }
    
    let html = '';
    matches.slice(0, 8).forEach((location, index) => {
        html += `
            <div class="suggestion-item" data-index="${index}" onclick="selectSuggestion('${type}', ${index})">
                <div class="suggestion-main">${location.name}</div>
                <div class="suggestion-sub">${location.fullName}</div>
            </div>
        `;
    });
    
    suggestions.innerHTML = html;
    suggestions.classList.remove('d-none');
    
    // Store current matches for keyboard navigation
    suggestions._currentMatches = matches.slice(0, 8);
    suggestions._activeIndex = -1;
}

function hideSuggestions(type) {
    const suggestions = document.getElementById(`${type}-suggestions`);
    suggestions.classList.add('d-none');
    suggestions._activeIndex = -1;
}

function findLocationMatches(query) {
    const queryLower = query.toLowerCase();
    const matches = [];
    
    // Find exact matches first
    nigerianLocations.forEach(location => {
        if (location.name.toLowerCase().startsWith(queryLower) || 
            location.fullName.toLowerCase().includes(queryLower)) {
            matches.push(location);
        }
    });
    
    // If we need more matches, add partial matches
    if (matches.length < 8) {
        nigerianLocations.forEach(location => {
            if (!matches.includes(location) && 
                (location.name.toLowerCase().includes(queryLower) || 
                 location.state.toLowerCase().includes(queryLower))) {
                matches.push(location);
            }
        });
    }
    
    return matches;
}

function selectSuggestion(type, index) {
    const suggestions = document.getElementById(`${type}-suggestions`);
    const matches = suggestions._currentMatches;
    
    if (matches && matches[index]) {
        const location = matches[index];
        
        // Set the input value
        document.getElementById(`${type}_location`).value = location.fullName;
        
        // Set coordinates
        document.getElementById(`${type}_latitude`).value = formatCoordinate(location.coords.latitude);
        document.getElementById(`${type}_longitude`).value = formatCoordinate(location.coords.longitude);
        
        // Hide suggestions
        hideSuggestions(type);
        
        // Update estimates and map
        updateEstimates();
        updateMap();
        
        showAlert(`Selected: ${location.name}`, 'success', 2000);
    }
}

function handleSuggestionNavigation(e, type) {
    const suggestions = document.getElementById(`${type}-suggestions`);
    
    if (suggestions.classList.contains('d-none')) return;
    
    const items = suggestions.querySelectorAll('.suggestion-item');
    if (items.length === 0) return;
    
    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            suggestions._activeIndex = Math.min(suggestions._activeIndex + 1, items.length - 1);
            updateActiveSuggestion(type);
            break;
            
        case 'ArrowUp':
            e.preventDefault();
            suggestions._activeIndex = Math.max(suggestions._activeIndex - 1, -1);
            updateActiveSuggestion(type);
            break;
            
        case 'Enter':
            e.preventDefault();
            if (suggestions._activeIndex >= 0) {
                selectSuggestion(type, suggestions._activeIndex);
            }
            break;
            
        case 'Escape':
            hideSuggestions(type);
            break;
    }
}

function updateActiveSuggestion(type) {
    const suggestions = document.getElementById(`${type}-suggestions`);
    const items = suggestions.querySelectorAll('.suggestion-item');
    
    // Remove active class from all items
    items.forEach(item => item.classList.remove('active'));
    
    // Add active class to current item
    if (suggestions._activeIndex >= 0 && suggestions._activeIndex < items.length) {
        items[suggestions._activeIndex].classList.add('active');
        items[suggestions._activeIndex].scrollIntoView({ block: 'nearest' });
    }
}
</script>
{% endblock %}
